# AudioSync テスト戦略 (Test Strategy)

このドキュメントでは、AudioSyncプロジェクトにおけるテストの設計方針、構造、および開発ワークフローについて定義します。
私たちは「テストを品質のゲートキーパー」と位置づけ、安心してコード変更が行える状態を維持します。

## 1. テストの階層構造 (Test Pyramid)

テストを以下の3つのレイヤーに分け、実行速度と目的を明確にします。

| レベル | ディレクトリ | 目的 | 特徴 | 実行頻度 |
| :--- | :--- | :--- | :--- | :--- |
| **Unit (単体)** | `tests/unit/` | 関数・クラス単体のロジック検証 | **爆速**。DBやファイルシステムは原則モック化する。 | コード修正のたび (数秒) |
| **Integration (結合)** | `tests/integration/` | DB、ファイル操作、APIの連携検証 | **中速**。実際のSQLiteや一時ファイル(`/tmp`)を使用。 | 機能実装の区切り (数分) |
| **E2E (システム)** | `tests/e2e/` | ユーザー視点での動作検証 | **低速**。ブラウザ操作や実際のAndroid接続。 | リリース前 (数十分〜) |

### ディレクトリ構成
```text
tests/
├── unit/           # ロジック中心のテスト
├── integration/    # DB/FS/API連携テスト
├── e2e/            # (Future) ブラウザ/実機テスト
├── conftest.py     # 共通Fixture (DB接続設定など)
└── TEST_STRATEGY.md # 本ドキュメント
```

## 2. 開発ワークフロー (Workflow)

「常にテストが通る状態」を維持するため、以下のサイクルで開発を進めます。

### シナリオ: 既存機能の変更・バグ修正

1.  **現状確認 (Green)**
    *   作業前に全テストを実行し、すべて成功することを確認します。
    *   `rye run pytest` -> **ALL PASS**
2.  **テスト修正/作成 (Red)**
    *   これから実装する仕様に合わせて、**先にテストコードを修正または作成**します。
    *   期待する挙動をテストコードとして定義します。
    *   テスト実行 -> **FAIL** (未実装のため落ちる＝正しい)
3.  **実装 (Green)**
    *   テストが通るようにソースコードを修正します。
    *   テスト実行 -> **PASS**
4.  **回帰テスト (Regression)**
    *   他の機能を壊していないか、全テストを実行します。
    *   `rye run pytest` -> **ALL PASS**
5.  **コミット (Commit)**
    *   全てのテストが通った状態で `git commit` します。

## 3. テストの書き方ガイドライン

### ドキュメントとしてのテスト
テストコード自体が仕様書となるよう、ドキュメンテーション文字列（Docstring）を記述します。

```python
def test_scanner_should_skip_files_without_permission():
    """
    [Scanner] 権限のないファイルはスキップし、エラーログを記録すること。
    
    条件:
    1. 読み取り権限のない .mp3 ファイルが存在する
    2. スキャナーを実行する
    
    期待値:
    1. DBにトラックとして登録されないこと
    2. 処理が中断せず完了すること
    """
    # ... setup ...
    # ... execution ...
    # ... assertion ...
```

### 命名規則
*   ファイル名: `test_*.py`
*   関数名: `test_<対象機能>_<期待する挙動>` または `test_<対象機能>_<条件>`

## 4. 自動化と品質保証 (Automation)

将来的に以下の自動化を導入し、品質維持コストを下げます。

*   **Task Runner**: `rye run check` コマンド等で、LintとTestを一括実行。
*   **Pre-commit Hook**: コミット時に自動でテストを実行し、失敗したコードの混入を防ぐ。
*   **Coverage**: 定期的にカバレッジを計測し、テストされていない「死角」を把握する。

---
**合言葉**: "Keep the Build Green" (常にテストが通る状態を保とう)
